<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="date" content="2017-03-13T11:33:22EET">
    <title>Notakey Authentication Proxy v.1.0</title>
    <meta name="pdfkit-footer_right" content="Page [page] of [topage]">
    <meta name="pdfkit-footer_left" content="[title] | 2017-03-13">
    <meta name="pdfkit-footer_font_size" content="8">
    <link href="stylesheets/print.css" rel="stylesheet" media="all" />

</head>

<body class="pdf">

<section class="titlePage">
    <img src="images/hero_hand.png" class="heroHand" alt="Hero hand" />

    <div class="content">
        <h1 class="title">Notakey Authentication Proxy</h1>
        <h2 class="subtitle">Licensing Guide</h2>
        <p class="serial">NTKUM-AP-10317</p>
        <p class="date">2017-03-13</p>
        <p class="version">Version  1.0</p>
    </div>

    <footer>
        <p>
            <strong>Headquarters</strong><br/>
            Notakey Latvia SIA<br/>
            Ganu iela 3 - 12, LV-1010, Riga, Latvia<br/>
            <a href="https://www.notakey.com">https://www.notakey.com</a><br/>
            Tel.: +371 20 208 714<br/>
        </p>

        <p><strong>Confidential</strong> - For Internal and Partner Use Only</p>
        <p>&copy; 2017 Notakey Latvia SIA. All Rights Reserved.</p>
    </footer>
</section>

<section class="content">
    <p><img src="images/hero.png" title="Notakey Authentication Proxy" alt="Notakey Authentication Proxy running in Terminal" /></p>

<h1 id="introduction">Introduction</h1>

<p>Notakey Authentication Proxy (NtkP) is a proxy server that allows transparently adding Notakey-based
2-factor authentication in existing systems, which are using standard authentication protocols.</p>

<p>Currently, NtkP supports RADIUS with PAP and CHAP authentication types.</p>

<h1 id="technical-summary">Technical Summary</h1>

<p>NtkP manages a list of known IP addresses, which can send it requests. Each IP address
has a corresponding secret. Each of these IP addresses correspond to one upstream client.</p>

<p>NtkP also has one backing RADIUS server address and secret defined. This is the downstream RADIUS server.</p>

<p>When a RADIUS message is received, it will be transparently proxied to the downstream
server. Each incoming message will be decoded with the matching upstream secret, and
re-encoded with the downstream server&rsquo;s secret.</p>

<p>Each message returned by the downstream server will be similarly decoded and re-encoded,
to match the secret expected by the upstream client.</p>

<p>In addition, if the RADIUS message is an <code class="prettyprint">Access-Request</code> message, then
the username contained in the message will be passed to Notakey API, and
await verification. If the end-user denies this request on their smartphone, the response will be
changed, before being returned to the upstream client.</p>

<p>While waiting for the user to respond on their smartphone, upstream clients may
time out, and re-send the Access-Request message. In this case, the proxy will
attempt to handle duplicate requests, based on packet ID values and corresponding
usernames.</p>

<div style="page-break-inside:avoid;">

<h2>Flowchart</h2>

<img src="images/proxy_flow.png" />
<!-- ![Overview Flowchart](images/proxy_flow.png "Overview Flowchart") -->

<aside class="notice invisible-in-pdf">
See <a href="images/proxy_flow.png">enlarged version</a>.
</aside>

</div>

<h1 id="system-requirements">System Requirements</h1>

<h2 id="docker">Docker</h2>

<p>The recommended environment for NtkP is Docker, so any Docker-enabled host
should be fine.</p>

<h2 id="windows">Windows</h2>

<p>NtkP can alternatively be installed as a Windows system service. It has a dependency
on .NET Framework v4.5.</p>

<p>See: <a href="https://msdn.microsoft.com/en-us/library/8z6watww(v=vs.110).aspx">Microsoft .NET Framework v4.5 system requirements</a>.</p>

<h1 id="installation-instructions-docker">Installation instructions (Docker)</h1>

<p>The recommended way to obtain NtkP is by using Docker. It is published as the
<code class="prettyprint">notakey/authproxy</code> image. Use the tag <code class="prettyprint">latest</code> to always use the latest version,
or specify a specific version, using the tag.</p>
<pre class="highlight shell tab-shell"><code><span class="c"># Download the latest version</span>
<span class="gp">$ </span>docker pull notakey/authproxy:latest

<span class="c"># Download a specific version</span>
<span class="gp">$ </span>docker pull notakey/authproxy:1.0.0
</code></pre>
<p>The link to the Docker Hub page: <a href="https://hub.docker.com/r/notakey/authproxy/">Notakey Authentication Proxy on Docker Hub</a>.</p>

<h1 id="installation-instructions-msi">Installation instructions (MSI)</h1>

<aside class="notice">
The use of the MSI package is discouraged, in favor of the Docker version. The MSI
package will continue to be supported, however.
</aside>

<p>&hellip;</p>

<h1 id="configuration">Configuration</h1>

<h2 id="configuring-the-msi">Configuring the MSI</h2>

<p>&hellip;</p>

<h2 id="configuring-the-docker-image">Configuring the Docker image</h2>

<p>Parameters to the Docker image are set via environment variables.</p>
<pre class="highlight xml tab-xml"><code><span class="nt">&lt;argument&gt;</span>https://demo.notakey.com/api/<span class="nt">&lt;/argument&gt;</span>
<span class="nt">&lt;argument&gt;</span>65af8d56-b7d9-49b9-86c6-595dc440d933<span class="nt">&lt;/argument&gt;</span>
<span class="nt">&lt;argument&gt;</span>/unattended<span class="nt">&lt;/argument&gt;</span>
</code></pre>
<ul>
<li>The first argument should be a Notakey API endpoint (without the version number)
with a trailing slash.</li>
<li>The second argument should be a Notakey application access ID value. This value
can be found in the Notakey dashboard, when viewing a specific application.</li>
<li>The third argument should be left <code class="prettyprint">/unattended</code>.</li>
</ul>

<h1 id="network-connectivity">Network Connectivity</h1>

<p>NtkP will communicate with its RADIUS clients and the downstream RADIUS server
via one UDP port. This port can be different for clients and the downstream server,
but it can not be different for different clients.</p>

<p>Additionally, the TCP port 443 is required to be open between NtkP and the
designated Notakey API endpoint.</p>

<p><img src="images/network_connectivity.png" title="Network Connectivity Chart" alt="Network Connectivity Chart" /></p>

<aside class="notice invisible-in-pdf">
See <a href="images/network_connectivity.png">enlarged version</a>.
</aside>

<h1 id="log-files">Log files</h1>

<p>The credential provider does not perform any logging.</p>

<p>However, the background service will create log files in the package&rsquo;s
<code class="prettyprint">NotakeyBGService</code> folder.</p>

<h2 id="winsw-err-log">winsw.err.log</h2>

<p>This file will contain information about errors.</p>

<h2 id="winsw-out-log">winsw.out.log</h2>

<p>This file will contain informational output without errors.</p>

<h1 id="status-messages">Status Messages</h1>

<p>The logon UI will provide a status message, which reflects the status of the
background service.</p>

<p>The status will be re-checked every 10 seconds. Upon failure, the status check interval
will become progressively larger (exponential backoff).</p>

<h2 id="service-status-ok">Service Status: OK</h2>

<p>This message means that the background service is operational, and accessible,
and that the specified API endpoint is valid and reachable.</p>

<h2 id="service-status-health-check-request-timed-out-is-the-background-service-running">Service Status: health-check request timed out. Is the background service running?</h2>

<p>This message means that the background service is not running, or there is a permission
problem, which blocks the logon UI from communicating with it, using named pipes.</p>

<p>Double-check if the service is started, and if its identity is not restricted
from using named pipes.</p>

<h2 id="service-status-service-can-not-connect-to-api-check-network-connectivity-and-api-parameters">Service Status: service can not connect to API. Check network connectivity and API parameters.</h2>

<p>The background service is operational, but the API endpoint is not reachable.</p>

<p>Double-check network connectivity, firewall rules and the API endpoint URL.</p>

<h2 id="service-status-api-call-timed-out">Service Status: API call timed out.</h2>

<p>The background service is operational, and the API endpoint was reachable at some point,
but not anymore.</p>

<p>Double-check network connectivity, and if the Notakey server can be reached.</p>

<h2 id="service-status-error-error-message">Service Status: error (&lt;error message&gt;)</h2>

<p>This is a generic error message for unexpected issues.</p>

<h1 id="faq">FAQ</h1>

<h2 id="does-ntkp-listen-on-only-one-port-are-accounting-messages-supported">Does NtkP listen on only one port? Are accounting messages supported?</h2>

<p>NtkP only listens to one port, and it expects authentication messages to be sent
on this port.</p>

<p>Listening to accounting messages is not currently supported.</p>

<h2 id="what-are-the-implications-for-only-supporting-pap-and-chap-authentication-modes">What are the implications for only supporting PAP and CHAP authentication modes?</h2>

<p>PAP and CHAP do not sufficiently protect user credentials from man-in-the-middle
attacks.</p>

<p>These authentication types may be deemed secure-enough for use on an internal network,
where the risk for a MitM attack can be mitigated with other means.</p>

<aside class="warning">
You should <em>never</em> use PAP and CHAP in an uncontrolled environment.
</aside>

<h2 id="why-does-ntkp-support-only-pap-and-chap">Why does NtkP support only PAP and CHAP?</h2>

<p>PAP and CHAP are good enough for many use cases, so we have prioritized other tasks
over implementing more authentication methods.</p>

<p>Implementing more authentication methods is on our roadmap, however.</p>

</section>
</body>
</html>

