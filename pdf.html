<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="date" content="2017-03-09T10:52:02EET">
    <title>Notakey Credential Provider for Windows v.</title>
    <meta name="pdfkit-footer_right" content="Page [page] of [topage]">
    <meta name="pdfkit-footer_left" content="[title] | 2017-03-09">
    <meta name="pdfkit-footer_font_size" content="8">
    <link href="stylesheets/print.css" rel="stylesheet" media="all" />

</head>

<body class="pdf">

<section class="titlePage">
        <img src="images/logo.png" alt="Logo" />

    <h1>Notakey Credential Provider for Windows</h1>

    <footer>
        <div>Version  </div>
        <div>Date: 2017-03-09</div>
    </footer>
</section>
<section class="content">
    <p><img src="images/hero.png" title="Logon using RDP" alt="Windows login screenshot" /></p>

<h1 id="introduction">Introduction</h1>

<p>The Notakey Credential Provider (NtkCp) is a Windows plugin, which extends
the logon UI with a new mechanism, which injects Notakey 2FA in the normal
logon scenario.</p>

<h1 id="technical-summary">Technical Summary</h1>

<p>NtkCp consists of 2 components:</p>

<ul>
<li>a Windows COM component, which implements the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb776042(v=vs.85).aspx">ICredentialProvider</a> and
<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh706912(v=vs.85).aspx">ICredentialProviderCredential2</a> interfaces.</li>
<li>a Windows service, which communicates with the credential provider via named pipes,
and with a Notakey API endpoint.</li>
</ul>

<p>The credential provider provides a username and password input fields. The provided
username is sent to the Notakey API, to request approval on the user&rsquo;s smartphone.</p>

<p>If the username is not found (i.e. the user does not exist or has not been
onboarded on the Notakey server), the login attempt will fail with a message.</p>

<p>If the username is found, and the attempt is denied, the logon attempt will fail with an error.</p>

<p>If the user approves the logon attempt, then the provided username and password are processed as
they would normally. If the entered password is incorrect, then the logon attempt will
fail with a message.</p>

<h1 id="installation-instructions-zip">Installation instructions (*.zip)</h1>
<pre class="highlight shell tab-shell"><code><span class="c"># The expected ZIP package contents</span>
package.zip
├── NotakeyBGService
│   ├── winsw.exe
│   ├── winsw.xml
│   └── bin
│       └── Release
│           ├── <span class="k">*</span>.dll
│           ├── <span class="k">*</span>.xml
│           └── NotakeyBGService.exe
├── NotakeyNETProvider
│   └── bin
│       └── x64
│           └── Release
│               ├── <span class="k">*</span>.dll
│               └── <span class="k">*</span>.xml
├── register.bat
├── register.reg
└── unregister.bat
</code></pre>
<p>Place the contents of the package in the desired location (e.g. <code class="prettyprint">C:\ntkcp</code>)
and then run <code class="prettyprint">register.bat</code> as administrator.</p>

<p>This script will create a new system service (<code class="prettyprint">Notakey BG Service</code>), and
register the credential provider in the registry.</p>

<p>To remove the provider from the system, run <code class="prettyprint">unregister.bat</code> as the administrator.</p>

<aside class="notice">
After running <code>register.bat</code>, be sure to make the service restart
on failure. This will prevent the credential provider from becoming unusable, in
case of an unexpected issue.
</aside>

<h2 id="32-bit-systems">32-bit systems</h2>

<p>On 32-bit systems, the package should contain a <code class="prettyprint">register32.bat</code> and <code class="prettyprint">unregister32.bat</code>
file. These should be used to register the service and credential provider.</p>

<p>There are no other user-facing changes between 32-bit and 64-bit packages.</p>

<h1 id="configuring-the-api-endpoint">Configuring the API endpoint</h1>

<p>After installation, the background service must be configured to connect
to the desired Notakey API endpoint.</p>

<p>This is done by modifying the <code class="prettyprint">NotakeyBGService\winsw.xml</code> file. This file should contain
three argument tags:</p>
<pre class="highlight xml tab-xml"><code><span class="nt">&lt;argument&gt;</span>https://demo.notakey.com/api/<span class="nt">&lt;/argument&gt;</span>
<span class="nt">&lt;argument&gt;</span>65af8d56-b7d9-49b9-86c6-595dc440d933<span class="nt">&lt;/argument&gt;</span>
<span class="nt">&lt;argument&gt;</span>/unattended<span class="nt">&lt;/argument&gt;</span>
</code></pre>
<ul>
<li>The first argument should be a Notakey API endpoint (without the version number)
with a trailing slash.</li>
<li>The second argument should be a Notakey application access ID value. This value
can be found in the Notakey dashboard, when viewing a specific application.</li>
<li>The third argument should be left <code class="prettyprint">/unattended</code>.</li>
</ul>

<h1 id="network-connectivity">Network Connectivity</h1>

<p>The background service will attempt to connect to its specified Notakey endpoint.</p>

<p>If the endpoint URL uses <code class="prettyprint">https://</code>, then port <code class="prettyprint">443</code> will be used. Otherwise,
the port <code class="prettyprint">80</code> will be used.</p>

<p>There are no expected inbound connections.</p>

<h1 id="log-files">Log files</h1>

<p>The credential provider does not perform any logging.</p>

<p>However, the background service will create log files in the package&rsquo;s
<code class="prettyprint">NotakeyBGService</code> folder.</p>

<h2 id="winsw-err-log">winsw.err.log</h2>

<p>This file will contain information about errors.</p>

<h2 id="winsw-out-log">winsw.out.log</h2>

<p>This file will contain informational output without errors.</p>

<h1 id="status-messages">Status Messages</h1>

<p>The logon UI will provide a status message, which reflects the status of the
background service.</p>

<p>The status will be re-checked every 10 seconds. Upon failure, the status check interval
will become progressively larger (exponential backoff).</p>

<h2 id="service-status-ok">Service Status: OK</h2>

<p>This message means that the background service is operational, and accessible,
and that the specified API endpoint is valid and reachable.</p>

<h2 id="service-status-health-check-request-timed-out-is-the-background-service-running">Service Status: health-check request timed out. Is the background service running?</h2>

<p>This message means that the background service is not running, or there is a permission
problem, which blocks the logon UI from communicating with it, using named pipes.</p>

<p>Double-check if the service is started, and if its identity is not restricted
from using named pipes.</p>

<h2 id="service-status-service-can-not-connect-to-api-check-network-connectivity-and-api-parameters">Service Status: service can not connect to API. Check network connectivity and API parameters.</h2>

<p>The background service is operational, but the API endpoint is not reachable.</p>

<p>Double-check network connectivity, firewall rules and the API endpoint URL.</p>

<h2 id="service-status-api-call-timed-out">Service Status: API call timed out.</h2>

<p>The background service is operational, and the API endpoint was reachable at some point,
but not anymore.</p>

<p>Double-check network connectivity, and if the Notakey server can be reached.</p>

<h2 id="service-status-error-error-message">Service Status: error (&lt;error message&gt;)</h2>

<p>This is a generic error message for unexpected issues.</p>

<h1 id="faq">FAQ</h1>

<h2 id="does-ntkcp-work-with-local-users-or-domain-users">Does NtkCp work with local users or domain users?</h2>

<p>NtkCp works with both local and domain users. The entered username
must match the username that has been onboarded in the Notakey Dashboard.</p>

<h2 id="can-ntkcp-be-used-in-an-environment-that-requires-smartcard-logon">Can NtkCp be used in an environment that requires smartcard logon?</h2>

<p>No, NtkCp is a proxy for the normal username/password logon method.</p>

<h2 id="cant-the-users-choose-a-different-credential-method-and-sidestep-notakey-authentication">Can&rsquo;t the users choose a different credential method, and sidestep Notakey authentication?</h2>

<p>If other credential providers are enabled, the users will be able to use them
and sidestep Notakey authentication.</p>

<p>To mitigate this, you can disable other credential providers.</p>

<h2 id="can-users-use-safe-mode-to-sidestep-the-notakey-credential-provider">Can users use safe mode to sidestep the Notakey credential provider?</h2>

<p>Yes, in safe mode, the Notakey credential provider can be avoided. The system
will fallback to the default system credential providers.</p>

<h2 id="can-this-be-used-to-protect-remote-servers">Can this be used to protect remote servers?</h2>

<p>NtkCp can be used together with Remote Desktop Protocol (RDP).</p>

<h2 id="why-is-the-notakey-logon-option-missing-when-accessing-a-remote-server-via-rdp">Why is the Notakey logon option missing, when accessing a remote server via RDP?</h2>

<p>If Network Level Authentication (NLA) is enabled, users will be prompted locally
for either their smartcard, or their username/password credentials.</p>

<p>This is by design and can not be changed.</p>

<p>However, if other credential providers are disabled on the remote server, then
after the initial authentication, a second logon UI will be presented, where
the user will be able to use the Notakey credential provider.</p>

</section>
</body>
</html>

